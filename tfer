#! /bin/bash

### Filter out flags for tfer that start with --
args=()
flags=()
for arg in "$@"; do
  if [[ $arg == --* ]]; then
    flags+=("$arg")
  else
    args+=("$arg")
  fi
done
set -- "${args[@]}" "${flags[@]}"

for flag in "${flags[@]}"; do
  ### --help
  if [[ $flag == --help ]]; then
    echo "Usage: tfer [options] [terraform command and flags]"
    echo "Example: tfer --dir=terraform/ plan"
    echo ""
    echo "Options:"
    echo "  --help          Show this help message"
    echo "  --dir=<path>    Change to directory <path> before executing"
    echo "  --link-only     Only create symlinks, do not run terraform"
    exit 0
  fi
  ### Change directory if --dir flag is set
  if [[ $flag == --dir=* ]]; then
    dir="${flag#--dir=}"
    cd "$dir"
  fi
done

### Clean .tfer directory
rm -rf .tfer
mkdir .tfer | true

### Create symlinks
for file in $(find $PWD -name "*.tf" -o -name "*.tfvars"); do
  ln -s "$file" .tfer/
done
ln -s ${PWD}/.terraform.lock.hcl .tfer/.terraform.lock.hcl
ln -s ${PWD}/.terraform .tfer/.terraform
cd .tfer

### Run terraform
if [[ ! " ${flags[@]} " =~ " --link-only " ]]; then
  terraform "${args[@]}"
fi
